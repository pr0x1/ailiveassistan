<!DOCTYPE html>
<html>
<head>
    <title>Gemini Live ToolCall Bug MRE</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        #log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 15px;
            height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Gemini Live ToolCall Bug - MRE</h1>
    <p><strong>Instructions:</strong></p>
    <ol>
        <li>Replace "TU_API_KEY_AQUI" with your actual Gemini API key</li>
        <li>Click "Start Conversation"</li>
        <li>Grant microphone access when prompted</li>
        <li>Say: <strong>"What is the weather in Paris?"</strong></li>
        <li>Watch the logs for tool call handling</li>
    </ol>
    
    <button id="startButton">Start Conversation</button>
    <button id="stopButton">Stop Conversation</button>
    <button id="clearLog">Clear Log</button>
    
    <h3>Debug Log:</h3>
    <pre id="log"></pre>

    <script type="module">
       // import { GoogleGenerativeAI } from "https://unpkg.com/@google/generative-ai@0.21.0/dist/index.mjs"; // <--- Quitamos Modality
        import { GoogleGenerativeAI } from "https://unpkg.com/@google/generative-ai@latest/dist/index.mjs";
        // ‚ö†Ô∏è REPLACE WITH YOUR ACTUAL API KEY
        const apiKey = "AIzaSyDZd-Nyx0V1jtckafUvPdPIxtQ_ujKglS8";
        
        const logElement = document.getElementById('log');
        let session = null;
        let logCount = 0;

        function log(message, type = 'info') {
            logCount++;
            const timestamp = new Date().toISOString();
            const prefix = `[${logCount.toString().padStart(3, '0')}] ${timestamp}`;
            
            let logMessage;
            if (typeof message === 'string') {
                logMessage = `${prefix} ${message}`;
            } else {
                logMessage = `${prefix} ${JSON.stringify(message, null, 2)}`;
            }
            
            console.log(logMessage);
            
            const logLine = document.createElement('div');
            logLine.className = type;
            logLine.textContent = logMessage + '\n';
            logElement.appendChild(logLine);
            logElement.scrollTop = logElement.scrollHeight;
        }

        async function startConversation() {
            if (apiKey === "TU_API_KEY_AQUI") {
                log('‚ùå ERROR: Please replace TU_API_KEY_AQUI with your actual Gemini API key!', 'error');
                return;
            }

            log('üöÄ Starting conversation...', 'info');
            const ai = new GoogleGenerativeAI({ apiKey });

            // ‚úÖ IMPROVED: Simple dummy tool with proper structure
            const dummyTool = [{
                functionDeclarations: [{
                    name: 'get_weather',
                    description: 'Get the weather for a location',
                    parameters: {
                        type: 'OBJECT',
                        properties: { 
                            location: { 
                                type: 'STRING',
                                description: 'The location to get weather for'
                            } 
                        },
                        required: ['location'],
                    },
                }],
            }];

            log('üîß Tool configuration:', 'info');
            log(dummyTool);

            try {
                log('üîå Connecting to Gemini Live API...', 'info');
                
                session = await ai.live.connect({
                    // ‚úÖ IMPROVED: Use official Live API model that supports tools
                    model: 'gemini-2.5-flash-native-audio-preview-09-2025',
                    config: {
                        responseModalities:  ["AUDIO"],
                        tools: dummyTool,
                        systemInstruction: {
                            parts: [{
                                text: 'You are a helpful assistant. When asked about weather, use the get_weather tool to get the information.'
                            }]
                        }
                    },
                    callbacks: {
                        onopen: () => {
                            log('‚úÖ Connection OPENED successfully', 'success');
                        },
                        onclose: (event) => {
                            log(`üîå Connection CLOSED: ${event.reason || 'Unknown reason'}`, 'info');
                        },
                        onerror: (err) => {
                            log(`‚ùå Connection ERROR: ${err.message || err}`, 'error');
                        },
                        onmessage: async (msg) => {
                            log('üì® Received message:', 'info');
                            log(msg);

                            // ‚úÖ IMPROVED: Enhanced tool call handling
                            if (msg.toolCall) {
                                log('üõ†Ô∏è === TOOL CALL DETECTED ===', 'info');
                                log('Tool call details:', 'info');
                                log(msg.toolCall);
                                
                                if (msg.toolCall.functionCalls && msg.toolCall.functionCalls.length > 0) {
                                    log(`üìû Function calls count: ${msg.toolCall.functionCalls.length}`, 'info');
                                    
                                    for (let i = 0; i < msg.toolCall.functionCalls.length; i++) {
                                        const functionCall = msg.toolCall.functionCalls[i];
                                        log(`üìû Function call ${i + 1}:`, 'info');
                                        log({
                                            id: functionCall.id,
                                            name: functionCall.name,
                                            args: functionCall.args
                                        });
                                    }

                                    try {
                                        // ‚úÖ IMPROVED: Robust tool response creation
                                        const functionResponses = msg.toolCall.functionCalls.map(functionCall => ({
                                            id: functionCall.id,
                                            name: functionCall.name,
                                            response: { 
                                                result: `Weather in ${functionCall.args?.location || 'unknown location'}: Sunny, 22¬∞C. This is a hardcoded test response.` 
                                            }
                                        }));

                                        const toolResponse = { functionResponses };
                                        
                                        log('üì§ === SENDING TOOL RESPONSE ===', 'info');
                                        log('Tool response structure:', 'info');
                                        log(toolResponse);
                                        
                                        // ‚úÖ VALIDATION: Check response structure before sending
                                        log('üîç Validating tool response structure...', 'info');
                                        
                                        if (!toolResponse.functionResponses) {
                                            throw new Error('functionResponses is missing');
                                        }
                                        
                                        if (!Array.isArray(toolResponse.functionResponses)) {
                                            throw new Error('functionResponses is not an array');
                                        }
                                        
                                        if (toolResponse.functionResponses.length === 0) {
                                            throw new Error('functionResponses array is empty');
                                        }
                                        
                                        for (const response of toolResponse.functionResponses) {
                                            if (!response.id) throw new Error('Response missing id field');
                                            if (!response.name) throw new Error('Response missing name field');
                                            if (!response.response) throw new Error('Response missing response field');
                                        }
                                        
                                        log('‚úÖ Tool response validation passed', 'success');
                                        
                                        // ‚úÖ SEND TOOL RESPONSE
                                        await session.sendToolResponse(toolResponse);
                                        log('‚úÖ Tool response sent SUCCESSFULLY!', 'success');
                                        
                                    } catch (error) {
                                        log('‚ùå === TOOL RESPONSE FAILED ===', 'error');
                                        log(`Error message: ${error.message}`, 'error');
                                        log(`Error stack: ${error.stack}`, 'error');
                                        log('Full error object:', 'error');
                                        log(error);
                                        
                                        // ‚úÖ EMERGENCY FALLBACK: Try to send a minimal response
                                        try {
                                            log('üö® Attempting emergency fallback response...', 'info');
                                            const emergencyResponse = {
                                                functionResponses: [{
                                                    id: msg.toolCall.functionCalls[0]?.id || `fallback-${Date.now()}`,
                                                    name: msg.toolCall.functionCalls[0]?.name || 'get_weather',
                                                    response: { result: 'Emergency fallback response due to error.' }
                                                }]
                                            };
                                            
                                            log('Emergency response:', 'info');
                                            log(emergencyResponse);
                                            
                                            await session.sendToolResponse(emergencyResponse);
                                            log('‚úÖ Emergency fallback response sent successfully!', 'success');
                                            
                                        } catch (fallbackError) {
                                            log('‚ùå Emergency fallback also failed:', 'error');
                                            log(fallbackError);
                                        }
                                    }
                                } else {
                                    log('‚ö†Ô∏è Tool call received but no function calls found', 'error');
                                    log('Tool call structure:', 'error');
                                    log(msg.toolCall);
                                }
                            }
                            
                            // ‚úÖ LOG OTHER MESSAGE TYPES
                            if (msg.serverContent) {
                                if (msg.serverContent.modelTurn) {
                                    log('ü§ñ Model response received', 'info');
                                }
                                if (msg.serverContent.turnComplete) {
                                    log('‚úÖ Turn completed', 'success');
                                }
                            }
                            
                            if (msg.setupComplete) {
                                log('‚öôÔ∏è Setup completed', 'success');
                            }
                        }
                    }
                });

                log('‚úÖ Session created successfully', 'success');
                
                // ‚úÖ IMPROVED: Request microphone access
                try {
                    log('üé§ Requesting microphone access...', 'info');
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    log('‚úÖ Microphone access granted', 'success');
                    log('üó£Ô∏è Now say: "What is the weather in Paris?"', 'info');
                } catch (micError) {
                    log('‚ùå Microphone access denied:', 'error');
                    log(micError);
                }

            } catch (error) {
                log('‚ùå === FAILED TO START CONVERSATION ===', 'error');
                log(`Error message: ${error.message}`, 'error');
                log(`Error stack: ${error.stack}`, 'error');
                log('Full error object:', 'error');
                log(error);
            }
        }

        function stopConversation() {
            if (session) {
                log('üõë Stopping conversation...', 'info');
                session.close();
                session = null;
                log('‚úÖ Session manually closed', 'success');
            } else {
                log('‚ö†Ô∏è No active session to stop', 'info');
            }
        }

        function clearLog() {
            logElement.innerHTML = '';
            logCount = 0;
            log('üßπ Log cleared', 'info');
        }

        // ‚úÖ EVENT LISTENERS
        document.getElementById('startButton').onclick = startConversation;
        document.getElementById('stopButton').onclick = stopConversation;
        document.getElementById('clearLog').onclick = clearLog;

        // ‚úÖ INITIAL LOG
        log('üéØ Gemini Live ToolCall Bug MRE loaded', 'success');
        log('üìã Ready to test tool call functionality', 'info');
    </script>
</body>
</html>
